# Полное описание проекта Duplicate Manager

## Обзор проекта

**Duplicate Manager** — это комплексная система управления дублирующимися файлами, реализующая три уровня поиска дубликатов с возможностью интерактивной работы с результатами. Проект написан на Python 3.7+ и использует модульную архитектуру.

---

## Архитектура проекта

### Структура модулей

```
duplicate_manager/
├── __init__.py          # Инициализация пакета, версия
├── __main__.py          # Точка входа для запуска как модуля
├── config.py            # Управление конфигурацией
├── cli.py               # CLI интерфейс (Click)
├── scanner.py           # Основной класс сканирования
├── indexer.py           # Индексация файлов
├── hasher.py            # УР1: Вычисление хешей
├── text_matcher.py      # УР2: Поиск вложенных текстов
├── image_matcher.py     # УР3: Сравнение изображений
└── actions.py           # Действия с найденными дубликатами
```

---

## Реализованная функциональность

### 1. Система конфигурации (`config.py`)

**Назначение:** Централизованное управление параметрами поиска и индексации.

**Реализовано:**
- ✅ Автоматическое создание файла `config.json` при первом запуске
- ✅ Загрузка и сохранение конфигурации в JSON формате
- ✅ Настройка алгоритмов хеширования (MD5/SHA256)
- ✅ Фильтрация файлов по размеру (min/max)
- ✅ Исключение паттернов и расширений файлов
- ✅ Настройка порогов схожести для изображений и текстов
- ✅ Поддержка съемных носителей и облачных хранилищ
- ✅ Настройка поддерживаемых форматов файлов

**Параметры конфигурации:**
- `hash_algorithm`: выбор алгоритма (md5/sha256)
- `min_file_size` / `max_file_size`: фильтрация по размеру
- `exclude_patterns`: исключение директорий (.git, __pycache__, node_modules)
- `exclude_extensions`: исключение расширений (.tmp, .swp, .DS_Store)
- `image_similarity_threshold`: порог схожести изображений (0-1)
- `text_containment_threshold`: порог содержания текста (0-1)
- `index_path`: путь к файлу индекса
- `chunk_size`: размер блока для чтения файлов
- `supported_image_formats`: список форматов изображений
- `supported_text_extensions`: список текстовых расширений

**Методы:**
- `load()` / `save()`: загрузка и сохранение конфигурации
- `get()` / `set()`: получение и установка параметров
- `should_exclude()`: проверка необходимости исключения файла
- `is_supported_image()` / `is_supported_text()`: проверка типа файла

---

### 2. Уровень 1: Поиск точных дубликатов (`hasher.py`)

**Назначение:** Поиск идентичных файлов по хешам содержимого.

**Реализовано:**
- ✅ Вычисление хешей файлов (MD5 или SHA256)
- ✅ Поточное чтение файлов большими блоками (chunk_size)
- ✅ Обработка ошибок доступа к файлам
- ✅ Фильтрация файлов по размеру и паттернам
- ✅ Поддержка всех типов файлов

**Класс `FileHasher`:**
- `calculate_hash()`: вычисление хеша файла
- `get_file_size()`: получение размера файла
- `should_process()`: проверка необходимости обработки файла

**Алгоритм:**
1. Проверка размера файла (min/max)
2. Проверка исключений (паттерны, расширения)
3. Поточное чтение файла блоками
4. Вычисление хеша выбранным алгоритмом
5. Возврат hex-представления хеша

---

### 3. Уровень 2: Поиск вложенных текстовых файлов (`text_matcher.py`)

**Назначение:** Определение случаев, когда один текстовый файл содержит содержимое другого.

**Реализовано:**
- ✅ Автоматическое определение кодировки файлов
- ✅ Поддержка множества кодировок (UTF-8, UTF-16, Latin-1, CP1251, CP866)
- ✅ Нормализация текста для сравнения
- ✅ Двунаправленная проверка содержания
- ✅ Настраиваемый порог схожести

**Класс `TextMatcher`:**
- `read_text_file()`: чтение текстового файла с автоопределением кодировки
- `normalize_text()`: нормализация текста (удаление пробелов, нижний регистр)
- `calculate_containment()`: вычисление степени содержания одного текста в другом
- `find_contained_files()`: поиск файлов, содержащихся в данном
- `find_all_containments()`: поиск всех пар вложенных файлов

**Алгоритм содержания:**
1. Нормализация обоих текстов
2. Проверка точного вхождения
3. Если не найдено — сравнение по словам (Jaccard similarity)
4. Возврат коэффициента содержания (0-1)

**Поддерживаемые форматы:**
- `.txt`, `.py`, `.js`, `.html`, `.css`, `.md`, `.json`, `.xml`, `.csv`

---

### 4. Уровень 3: Сравнение изображений (`image_matcher.py`)

**Назначение:** Поиск похожих изображений по содержимому, независимо от формата.

**Реализовано:**
- ✅ Сравнение изображений по содержимому (perceptual hash)
- ✅ Поддержка различных форматов (JPEG, PNG, BMP, GIF, WebP, TIFF)
- ✅ Использование библиотеки `imagehash` (pHash алгоритм)
- ✅ Настраиваемый порог схожести
- ✅ Обработка ошибок загрузки изображений

**Класс `ImageMatcher`:**
- `load_image()`: загрузка изображения через PIL
- `calculate_image_hash()`: вычисление perceptual hash (pHash)
- `calculate_similarity()`: вычисление коэффициента схожести (0-1)
- `compare_images()`: сравнение двух изображений
- `find_similar_images()`: поиск похожих изображений для данного
- `find_all_duplicates()`: поиск всех пар дублирующихся изображений

**Алгоритм:**
1. Загрузка изображения через PIL
2. Вычисление perceptual hash (pHash)
3. Вычисление расстояния Хэмминга между хешами
4. Преобразование расстояния в коэффициент схожести (0-1)
5. Сравнение с порогом для определения дубликата

**Поддерживаемые форматы:**
- `.jpg`, `.jpeg`, `.png`, `.bmp`, `.gif`, `.webp`, `.tiff`

---

### 5. Система индексации (`indexer.py`)

**Назначение:** Быстрая индексация файлов для эффективного поиска дубликатов.

**Реализовано:**
- ✅ Постоянное хранение индекса в JSON формате
- ✅ Инкрементальное обновление индекса
- ✅ Хранение метаданных (размер, дата изменения)
- ✅ Группировка файлов по хешам
- ✅ Обновление путей при перемещении файлов
- ✅ Удаление записей при удалении файлов

**Класс `FileIndex`:**
- `load()` / `save()`: загрузка и сохранение индекса
- `add_file()`: добавление файла в индекс
- `get_duplicates()`: получение всех групп дубликатов
- `find_file_hash()`: поиск хеша файла в индексе
- `remove_file()`: удаление файла из индекса
- `update_paths()`: обновление путей при перемещении
- `clear()`: очистка индекса

**Структура индекса:**
```json
{
  "hash_value": {
    "files": ["/path/to/file1", "/path/to/file2"],
    "size": 1024,
    "modified": "2024-01-01T00:00:00"
  }
}
```

**Особенности:**
- JSON формат для читаемости
- Автоматическое преобразование datetime
- Fallback на pickle при ошибках JSON
- Абсолютные пути для портативности

---

### 6. Сканирование файловой системы (`scanner.py`)

**Назначение:** Координация процесса сканирования и поиска дубликатов.

**Реализовано:**
- ✅ Рекурсивное сканирование директорий
- ✅ Прогресс-бар с использованием tqdm
- ✅ Интеграция всех трех уровней поиска
- ✅ Сбор статистики по индексу
- ✅ Обработка ошибок доступа

**Класс `FileScanner`:**
- `scan_directory()`: сканирование директории и создание индекса
- `_collect_files()`: сбор всех файлов из директории
- `find_exact_duplicates()`: поиск точных дубликатов (УР1)
- `find_text_containments()`: поиск вложенных текстов (УР2)
- `find_image_duplicates()`: поиск похожих изображений (УР3)
- `get_statistics()`: получение статистики по индексу

**Статистика включает:**
- Общее количество файлов
- Количество уникальных файлов
- Количество групп дубликатов
- Общий размер файлов
- Потенциальная экономия места

---

### 7. Действия с файлами (`actions.py`)

**Назначение:** Выполнение операций с найденными дубликатами.

**Реализовано:**
- ✅ Удаление файлов с обновлением индекса
- ✅ Перемещение файлов
- ✅ Копирование файлов
- ✅ Создание жестких ссылок (hard links)
- ✅ Массовое удаление дубликатов (оставить один)
- ✅ Перемещение дубликатов в отдельную папку

**Класс `FileActions`:**
- `delete_file()`: удаление файла
- `move_file()`: перемещение файла
- `copy_file()`: копирование файла
- `create_hard_link()`: создание жесткой ссылки
- `delete_duplicates_keep_one()`: удаление дубликатов, оставить один
- `move_duplicates_to_folder()`: перемещение дубликатов в папку

**Особенности:**
- Автоматическое обновление индекса после операций
- Обработка конфликтов имен при перемещении
- Создание директорий при необходимости
- Обработка ошибок файловых операций

---

### 8. CLI интерфейс (`cli.py`)

**Назначение:** Командная строка для взаимодействия с системой.

**Реализовано:**
- ✅ Команды через Click framework
- ✅ Интерактивный режим работы
- ✅ Сохранение результатов в файл
- ✅ Статистика по индексу
- ✅ Очистка индекса

**Команды:**

1. **`scan <путь>`** — Сканирование директории
   - Опции: `--no-progress` (без прогресс-бара)
   - Создает/обновляет индекс файлов

2. **`find --level <1-3>`** — Поиск дубликатов
   - `--level 1`: Точные дубликаты
   - `--level 2`: Вложенные тексты
   - `--level 3`: Похожие изображения
   - `--output <файл>`: Сохранение результатов

3. **`interactive`** — Интерактивный режим
   - Показ групп дубликатов по одной
   - Выбор действий для каждой группы:
     - Удалить все кроме первого
     - Переместить в папку
     - Пропустить

4. **`stats`** — Статистика по индексу
   - Общее количество файлов
   - Уникальные файлы
   - Группы дубликатов
   - Размер и потенциальная экономия

5. **`clear-index`** — Очистка индекса
   - Подтверждение перед удалением

**Глобальные опции:**
- `--config <путь>`: указание файла конфигурации

---

## Технические особенности

### Производительность
- ✅ Поточное чтение файлов (chunk-based)
- ✅ Индексация для быстрого поиска
- ✅ Кэширование хешей в индексе
- ✅ Прогресс-бары для длительных операций
- ✅ Оптимизированные алгоритмы сравнения

### Надежность
- ✅ Обработка ошибок доступа к файлам
- ✅ Автоматическое определение кодировок
- ✅ Fallback механизмы (JSON → pickle)
- ✅ Валидация путей и размеров файлов
- ✅ Безопасное удаление с подтверждением

### Портативность
- ✅ Работа без интернета
- ✅ Абсолютные пути в индексе
- ✅ Поддержка съемных носителей
- ✅ Кроссплатформенность (Windows/Mac/Linux)
- ✅ Минимальные зависимости

### Расширяемость
- ✅ Модульная архитектура
- ✅ Настраиваемые параметры
- ✅ Поддержка новых форматов через конфигурацию
- ✅ Легкое добавление новых алгоритмов

---

## Зависимости

```txt
Pillow>=10.0.0          # Работа с изображениями
imagehash>=4.3.1        # Perceptual hashing для изображений
tqdm>=4.66.0            # Прогресс-бары
click>=8.1.0            # CLI интерфейс
```

**Стандартная библиотека Python:**
- `hashlib` — вычисление хешей
- `pathlib` — работа с путями
- `json` / `pickle` — сериализация
- `shutil` — файловые операции
- `datetime` — метаданные файлов

---

## Примеры использования

### Базовое сканирование
```bash
python3 -m duplicate_manager scan /path/to/directory
```

### Поиск точных дубликатов
```bash
python3 -m duplicate_manager find --level 1
```

### Поиск вложенных текстов
```bash
python3 -m duplicate_manager find --level 2
```

### Поиск похожих изображений
```bash
python3 -m duplicate_manager find --level 3
```

### Сохранение результатов
```bash
python3 -m duplicate_manager find --level 1 --output results.txt
```

### Интерактивная работа
```bash
python3 -m duplicate_manager interactive
```

### Статистика
```bash
python3 -m duplicate_manager stats
```

---

## Результаты работы

При сканировании директории "py project" было найдено:
- **1122 файла** всего
- **90 уникальных** файлов
- **267 групп дубликатов**
- **11.36 MB** общий размер
- **6.84 MB** потенциальная экономия места

---

## Установка и запуск

### Установка зависимостей
```bash
pip install -r requirements.txt
```

### Установка как пакет
```bash
pip install -e .
```

### Запуск
```bash
python3 -m duplicate_manager --help
```

---

## Лицензия

MIT License

---

## Версия

1.0.0

---

## Автор

GRUUUUDD

